#!/usr/bin/env bash

APP_PROJECT_DIR=$1
APP_BUILD_DIR="$1/build"
APP_INSTALL_CONTAINER=$APP_BUILD_DIR/lazrbot
APP_UPLOAD_DIR=$APP_BUILD_DIR/upload
CODEDEPLOY_FILES=$APP_PROJECT_DIR/ci/codedeploy

mkdir -p $APP_INSTALL_CONTAINER && mkdir -p $APP_UPLOAD_DIR
touch $APP_INSTALL_CONTAINER/env || exit 1
cat << EOF > $APP_INSTALL_CONTAINER/env
DISCORD_AUTH_TOKEN=$2
CLOUDWATCH_ACCESS_KEY_ID=$3
CLOUDWATCH_SECRET_ACCESS_KEY=$4
CLOUDWATCH_REGION=$5
NODE_ENV=prod


DISCORD_AUTH_TOKEN=$2
AWS_ACCESS_KEY_ID=$3
AWS_SECRET_ACCESS_KEY=$4
CLOUDWATCH_REGION=$5
DYNAMODB_REGION=$5
CLOUDWATCH_STREAM=prod
LOG_LEVEL=info
EOF

node $APP_PROJECT_DIR/src/node_modules/pkg/lib-es5/bin.js $APP_PROJECT_DIR/src/lazrbot.js -t node10-linux-x64 --out-path $APP_INSTALL_CONTAINER || exit 1
cp -r $CODEDEPLOY_FILES/* $APP_INSTALL_CONTAINER && mv $APP_INSTALL_CONTAINER/appspec.yml $APP_BUILD_DIR
cd $APP_BUILD_DIR && zip -r lazrbot.zip lazrbot appspec.yml && mv lazrbot.zip $APP_UPLOAD_DIR